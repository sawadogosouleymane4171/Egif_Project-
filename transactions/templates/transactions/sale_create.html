{% extends "store/base.html" %}
{% load static %}
<!-- Page title  -->
{% block title %}Create sale{% endblock title %}

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}
<!--Select2 CSS-->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ttskch/select2-bootstrap4-theme@1.5.2/dist/select2-bootstrap4.min.css">
{% endblock stylesheets %}

<!-- Page Heading -->
<h2>Add sale</h2>

<!-- Page content  -->
{% block content %}
<div class="container py-5">
    <!-- Go back -->
    <div class="mb-4">
        <a href="{% url 'saleslist' %}" class="btn btn-outline-success">
            <i class="fas fa-arrow-left me-2"></i>
            Go back
        </a>
    </div>

    <!-- Sale items and details -->
    <form id="form_sale" action="{% url 'sale-create' %}" class="saleForm" method="post">
        <div class="row">
            <!-- Left column -->
            <div class="col-lg-8 mb-4">
                <div class="card border-light shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Sale Items</h5>
                    </div>
                    <div class="card-body">
                        <!-- Search item -->
                        <div class="mb-4">
                            <label for="searchbox_items" class="form-label">Search Item:</label>
                            <select class="form-select select2" name="searchbox_items" id="searchbox_items" aria-label="Search items"></select>
                        </div>

                        <!-- Delete all items from sale -->
                        <button type="button" class="btn btn-danger btn-sm mb-4 deleteAll">
                            <i class="fas fa-trash-alt me-2"></i> Delete All Items
                        </button>

                        <!-- Items Table -->
                        <div class="table-responsive my-3">
                            <table class="table table-bordered table-striped" id="table_items">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Name</th>
                                        <th>Price</th>
                                        <th>Quantity</th>
                                        <th>Total </th>
                                        <th class="text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Left Column -->

            <!-- Right Column -->
            <div class="col-lg-4 mb-4">
                <div class="card border-light shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Sale Details</h5>
                    </div>
                    <div class="card-body">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="customer" class="form-label">Customer</label>
                            <select name="customer" class="form-select" id="customer" aria-label="Customer" required>
                                <option value="" selected disabled hidden>Select the customer</option>
                                {% for customer in customers %}
                                <option value="{{ customer.value }}">{{ customer.label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="sub_total" class="form-label">Subtotal</label>
                            <input name="sub_total" type="number" class="form-control" id="sub_total" aria-label="Subtotal" required>
                        </div>
                        <div class="mb-3">
                            <label for="tax_percentage" class="form-label">Tax Inclusive (%)</label>
                            <input name="tax_percentage" type="number" class="form-control" id="tax_percentage" aria-label="Tax Inclusive" value="0" required>
                        </div>
                        <div class="mb-3">
                            <label for="tax_amount" class="form-label">Tax Amount</label>
                            <input name="tax_amount" type="number" class="form-control" id="tax_amount" aria-label="Tax Amount" required>
                        </div>
                        <div class="mb-3">
                            <label for="grand_total" class="form-label">Grand Total</label>
                            <input name="grand_total" type="number" class="form-control" id="grand_total" aria-label="Grand Total" required>
                        </div>
                        <div class="mb-3">
                            <label for="amount_paid" class="form-label">Amount Payed</label>
                            <input name="amount_paid" type="number" class="form-control" id="amount_paid" aria-label="Amount Paid" required>
                        </div>
                        <button type="submit" class="btn btn-success w-100">Create Sale</button>
                    </div>
                </div>
            </div>
            <!-- End Right Column -->
        </div>
    </form>
</div>
{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}
<!-- Datatables -->
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js" defer></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap4.min.js" defer></script>

<!-- Select2 -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js" defer></script>

<!-- Bootstrap Touchspin -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-touchspin/3.1.0/jquery.bootstrap-touchspin.min.js" defer></script>

<!-- Sweet Alert -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.6.15/dist/sweetalert2.all.min.js" defer></script>

<script>
    
      // Helpers de parsing sûrs
    function parseFloatSafe(val) {
        if (val === null || val === undefined) return 0;
        if (typeof val === 'number') return val;
        var s = String(val).trim();
        s = s.replace(/\s+/g, '');       // enlever espaces
        s = s.replace(/,/g, '.');        // virgule -> point
        s = s.replace(/[^0-9.\-]/g, ''); // retirer symboles comme $
        var n = parseFloat(s);
        return isNaN(n) ? 0 : n;
    }
    function parseIntSafe(val) {
        var n = parseInt(val, 10);
        return isNaN(n) ? 0 : n;
    }

    // Round util
    function roundTo(n, digits = 0) {
        var multiplicator = Math.pow(10, digits);
        n = parseFloat((n * multiplicator).toFixed(11));
        return Math.round(n) / multiplicator;
    }

    var number = 1;
    var tblItems = null;

    var sale = {
        products: {
            customer: 0,
            sub_total: 0.00,
            grand_total: 0.00,
            tax_amount: 0.00,
            tax_percentage: 0.00,
            amount_paid: 0.00,
            amount_change: 0.00,
            items: []
        },

        calculate_sale: function () {
            var sub_total = 0.00;
            var tax_percentage = parseFloatSafe($('input[name="tax_percentage"]').val());

            $.each(this.products.items, function (pos, dict) {
                dict.pos = pos;
                dict.quantity = parseIntSafe(dict.quantity) || 1;
                dict.price = parseFloatSafe(dict.price);
                dict.total_item = roundTo(dict.quantity * dict.price, 2);
                sub_total += roundTo(dict.total_item, 2);
            });

            this.products.sub_total = roundTo(sub_total, 2);
            this.products.tax_percentage = roundTo(tax_percentage, 2);
            this.products.tax_amount = roundTo(this.products.sub_total * (this.products.tax_percentage / 100), 2);
            this.products.grand_total = roundTo(this.products.sub_total + this.products.tax_amount, 2);

            $('input[name="sub_total"]').val(this.products.sub_total);
            $('input[name="tax_amount"]').val(this.products.tax_amount);
            $('input[name="grand_total"]').val(this.products.grand_total);
        },

        add_item: function (item) {
            // Normaliser price & quantity dès l'ajout
            item.price = parseFloatSafe(item.price);
            item.quantity = parseIntSafe(item.quantity) || 1;

            // Si l'item existe déjà (même id), on incrémente la quantité
            var existing = this.products.items.find(function (it) { return String(it.id) === String(item.id); });
            if (existing) {
                existing.quantity = (parseIntSafe(existing.quantity) || 1) + item.quantity;
            } else {
                item.number = number++;
                this.products.items.push(item);
            }

            this.list_item();
        },

        list_item: function () {
            // Recalcule
            this.calculate_sale();

            // Detruire la table si existe
            if ($.fn.DataTable.isDataTable('#table_items')) {
                $('#table_items').DataTable().destroy();
            }

            tblItems = $("#table_items").DataTable({
                destroy: true,
                data: this.products.items,
                columns: [
                    {"data": "number"},
                    {"data": "name"},
                    {"data": "price"},
                    {"data": "quantity"},
                    {"data": "total_item"},
                    {"data": "id"},
                ],
                columnDefs: [
                    {
                        // Quantity: champ editable
                        className: 'text-center',
                        targets: [3],
                        render: function (data, type, row) {
                            return '<input name="quantity" type="text" class="form-control form-control-xs text-center input-sm item-qty" autocomplete="off" value="' + row.quantity + '">';
                        },
                    },
                    {
                        // Prix (col 2) : afficher row.price
                        className: 'text-right',
                        targets: [2],
                        render: function (data, type, row) {
                            return (parseFloat(row.price) || 0).toFixed(2) + ' $';
                        },
                    },
                    {
                        // Total (col 4) : afficher row.total_item
                        className: 'text-right',
                        targets: [4],
                        render: function (data, type, row) {
                            return (parseFloat(row.total_item) || 0).toFixed(2) + ' $';
                        },
                    },
                    {
                        // Delete button
                        className: 'text-center',
                        targets: [-1],
                        orderable: false,
                        render: function (data, type, row) {
                            return '<a rel="delete" type="button" class="btn btn-sm btn-danger" data-bs-toggle="tooltip" title="Delete item"> <i class="fas fa-trash-alt fa-xs"></i> </a>';
                        },
                    },
                ],
                rowCallback: function (row, data, displayNum, displayIndex) {
                    $(row).find("input[name='quantity']").TouchSpin({
                        min: 1,
                        max: 100,
                        step: 1,
                        decimals: 0,
                        boostat: 1,
                        maxboostedstep: 3,
                        postfix: ''
                    });
                },
                paging: false,
                searching: false,
                info: false
            });

            // Handlers attachés après (évitons doublons en .off())
            var self = this;

            // Delete
            $('#table_items tbody').off('click', 'a[rel="delete"]').on('click', 'a[rel="delete"]', function () {
                var tr = $(this).closest('tr');
                var rowIndex = $('#table_items').DataTable().row(tr).index();
                if (rowIndex === undefined) return;
                var item_name = self.products.items[rowIndex].name;

                Swal.fire({
                    customClass: { confirmButton: 'ml-3 btn btn-danger', cancelButton: 'btn btn-success' },
                    buttonsStyling: false,
                    title: "Are you sure you want to delete this item from the sale?",
                    text: item_name,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Delete',
                    cancelButtonText: 'Cancel',
                    reverseButtons: true,
                }).then((result) => {
                    if (result.isConfirmed) {
                        self.products.items.splice(rowIndex, 1);
                        self.list_item();
                        Swal.fire('The item was eliminated!', '', 'success');
                    }
                });
            });

            // Quantity change: met à jour l'objet et recalcul
            $('#table_items tbody').off('change keyup', 'input[name="quantity"]').on('change keyup', 'input[name="quantity"]', function () {
                var tr = $(this).closest('tr');
                var rowIndex = $('#table_items').DataTable().row(tr).index();
                if (rowIndex === undefined) return;
                var quantity = parseIntSafe($(this).val()) || 1;
                self.products.items[rowIndex].quantity = quantity;
                self.calculate_sale();
                // mise à jour visuelle du total (on peut rerender la table entière si nécessaire)
                $('td:eq(4)', tblItems.row(rowIndex).node()).html((self.products.items[rowIndex].total_item || 0).toFixed(2) + ' $');
            });
        }
    };

    // Document ready
    $(document).ready(function () {
        // Tax percentage touchspin
        $("input[name='tax_percentage']").TouchSpin({
            min: 0, max: 100, step: 1, decimals: 2, boostat: 5, maxboostedstep: 10, postfix: '%'
        }).on('change', function () {
            sale.calculate_sale();
            sale.list_item();
        });

        // Select2 customers
        $('#searchbox_customers').select2({
            delay: 250,
            placeholder: "Select a customer",
            allowClear: true,
            minimumInputLength: 1,
            ajax: {
                url: "{% url 'get_customers' %}",
                type: 'POST',
                data: function (params) {
                    return {
                        term: params.term,
                        csrfmiddlewaretoken: $('input[name="csrfmiddlewaretoken"]').val() // Include CSRF token
                    };
                },
                processResults: function (data) {
                    return {
                        results: data
                    };
                }
            }
        }).on('select2:select', function (e) {
            // When a customer is selected
            var data = e.params.data;
            sale.products.customer = data.id;
        });

        // Select2 items searchbox
        $('#searchbox_items').select2({
            delay: 250, placeholder: 'Search an item', minimumInputLength: 1, allowClear: true,
            templateResult: function (repo) {
                if (!repo || !repo.name) return $('<span>Loading...</span>');
                return $(`<div class="card mb-1"><div class="card-body py-1"><small class="card-title">${repo.name}</small>${repo.price ? `<div><small>${parseFloat(repo.price).toFixed(2)} $</small></div>` : ''}</div></div>`);
            },
            ajax: {
                url: "{% url 'get_items' %}",
                type: 'POST',
                headers: { 'X-CSRFToken': $('input[name="csrfmiddlewaretoken"]').val() },
                data: function (params) { return { term: params.term }; },
                processResults: function (data) { return { results: data }; }
            }
        }).on('select2:select', function (e) {
            var data = e.params.data;
            // Par sécurité, forcer les types ici aussi
            if (!data.quantity) data.quantity = 1;
            data.price = parseFloatSafe(data.price);
            data.quantity = parseIntSafe(data.quantity) || 1;
            data.number = number;
            number++;
            sale.add_item(data);
            $(this).val('').trigger('change.select2');
        });

        // Initial empty DataTable (structure)
        tblItems = $('#table_items').DataTable({
            columnDefs: [{ targets: [-1], orderable: false }],
            paging: false,
            searching: false,
            info: false
        });

        // On form submit (AJAX)
        $('form#form_sale').on('submit', function (event) {
            event.preventDefault();

            var amountPaid = parseFloatSafe($('input[name="amount_paid"]').val());
            var grandTotal = parseFloatSafe($('input[name="grand_total"]').val()) || sale.products.grand_total;
            var amountChange = roundTo(amountPaid - grandTotal, 2);

            sale.products.amount_paid = amountPaid;
            sale.products.amount_change = amountChange;
            sale.products.tax_percentage = parseFloatSafe($('input[name="tax_percentage"]').val());

            var formData = {
                customer: $('select[name="customer"]').val(),
                sub_total: sale.products.sub_total,
                tax_percentage: sale.products.tax_percentage,
                tax_amount: sale.products.tax_amount,
                grand_total: sale.products.grand_total,
                amount_paid: sale.products.amount_paid,
                amount_change: sale.products.amount_change,
                items: sale.products.items
            };

            if (isNaN(amountChange)) {
                Swal.fire({ icon: 'error', title: 'Error', text: 'Amount change is required!' });
                return;
            }

            var csrftoken = $('input[name="csrfmiddlewaretoken"]').val();

            $.ajax({
                url: $(this).attr('action'),
                type: 'POST',
                contentType: 'application/json',
                headers: { 'X-CSRFToken': csrftoken },
                data: JSON.stringify(formData),
                success: function (response) {
                    sale.products.items = [];
                    sale.calculate_sale();
                    sale.list_item();
                    $('form#form_sale').trigger('reset');
                    $('#customer').val(null).trigger('change');
                    Swal.fire({ icon: 'success', title: 'Success', text: 'Sale has been completed successfully!' });
                },
                error: function (xhr) {
                    var msg = (xhr && xhr.responseJSON && xhr.responseJSON.message) ? xhr.responseJSON.message : 'An error occurred while processing the sale!';
                    Swal.fire({ icon: 'error', title: 'Error', text: msg });
                }
            });
        });
    });
</script>


{% endblock javascripts %}